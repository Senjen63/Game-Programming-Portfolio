#include "UnitManager.h"
#include "Unit.h"
#include "Animation.h"
#include "Sprite.h"
#include <fstream>

UnitManager::UnitManager() 
{
	ifstream input("../GalahadAssets/data/" + FILE_PATH);
	if (input.good())
	{
		string key;

		while (!input.eof())
		{
			input >> key;
			if (key == "half")
			{
				input >> mHalf;
			}
			else if (key == "cero")
			{
				input >> mZero;
			}
		}
	}
}

UnitManager::UnitManager(int size)
{
	ifstream input("../GalahadAssets/data/" + FILE_PATH);
	if (input.good())
	{
		string key;

		while (!input.eof())
		{
			input >> key;
			if (key == "half")
			{
				input >> mHalf;
			}
			else if (key == "cero")
			{
				input >> mZero;
			}
		}
	}

	mArrLength = size;
	mpUnits.reserve(mArrLength);
}

UnitManager::~UnitManager() 
{
	clearUnits();
}

void UnitManager::createAndAddUnit(Vector2D location, Animation mainAnimation, Animation altAnimation) 
{
	Unit* pUnit = new Unit(location);

	pUnit->setMainAnimation(mainAnimation);
	pUnit->setAltAnimation(altAnimation);
	pUnit->mHitbox = mainAnimation.getDimen();
	
	mpUnits.push_back(pUnit);
}

void UnitManager::createAndAddUnit(Vector2D location, Animation mainAnimation)
{

	Unit* pUnit = new Unit(location);

	pUnit->setMainAnimation(mainAnimation);
	pUnit->mHitbox = mainAnimation.getDimen();

	mpUnits.push_back(pUnit);
}

void UnitManager::addUnits(int quantity, Vector2D location, Animation mainAnimation, Animation altAnimation)
{
	for (int i = mZero; i < quantity; i++)
	{
		createAndAddUnit(location, mainAnimation, altAnimation);
	}
}

void UnitManager::addUnits(int quantity, Vector2D location, Animation mainAnimation)
{
	for (int i = mZero; i < quantity; i++)
	{
		createAndAddUnit(location, mainAnimation);
	}
}

void UnitManager::activateUnit(Vector2D pos)
{
	for (unsigned int i = mZero; i < mpUnits.size(); i++)
	{
		if (mpUnits[i]->mInUse == false)
		{
			mpUnits[i]->init(pos, mpUnits[mZero]->mHitbox);
		}
	}
}

void UnitManager::deactivateUnit(int uNum)
{
	mpUnits[uNum]->deinit();
}

void UnitManager::deleteUnit(Unit* pUnitToDelete) 
{
	for (unsigned int i = mZero; i < mpUnits.size(); i++)
	{
		Unit* pUnit = mpUnits[i];
		if (pUnit == pUnitToDelete)
		{
			delete pUnit;
			mpUnits.erase(mpUnits.begin() + i);
			break;
		}
	}
}

void UnitManager::deleteUnit(Vector2D clickedLocation)
{
	int smurfHeight;
	int smurfWidth;

	Vector2D bottomRightLocation;
	Vector2D topLeftLocation;

	for (unsigned int i = mZero; i < mpUnits.size(); i++)
	{
		Unit* pUnit = mpUnits[i];
		smurfHeight = pUnit->getCurrentAnimation().getCurrentSprite().getSpriteHeight();
		smurfWidth = pUnit->getCurrentAnimation().getCurrentSprite().getSpriteWidth();
		topLeftLocation = pUnit->getLocation();
		bottomRightLocation = Vector2D(pUnit->getLocation().getX() + smurfWidth, pUnit->getLocation().getY() + smurfHeight);
		if (clickedLocation.getX() >= topLeftLocation.getX() && clickedLocation.getX() <= bottomRightLocation.getX())
		{
			if (clickedLocation.getY() >= topLeftLocation.getY() && clickedLocation.getY() <= bottomRightLocation.getY())
			{
				delete pUnit;
				mpUnits.erase(mpUnits.begin() + i);
				break;
			}
		}
	}
}

void UnitManager::cleanScreen()
{
	for each (Unit* un in mpUnits)
	{
		un->mInUse = false;
	}
}

void UnitManager::clearUnits() 
{
	for (auto unit : mpUnits)
	{
		delete unit;
	}

	mpUnits.clear();
}

void UnitManager::updateAll(double dt) 
{
	for (auto unit : mpUnits) 
	{
		Unit* pUnit = unit;
		pUnit->update(dt);
	}
}

void UnitManager::drawAll() 
{
	for (auto unit : mpUnits) 
	{
		Unit* pUnit = unit;
		pUnit->draw();
	}
}

bool UnitManager::collideCheck(Unit* host, Unit* oncoming)
{
	if (abs(oncoming->getXPos() - host->getXPos()) <= host->getWidth() / mHalf + oncoming->getWidth() / mHalf && (host->getYPos() - oncoming->getYPos() <= host->getHeight() / mHalf + oncoming->getHeight() / mHalf || oncoming->getYPos() - host->getYPos() >= host->getHeight() / mHalf + oncoming->getHeight() / mHalf))
	{
		return true;
	}
	else
	{
		return false;
	}
}

void UnitManager::detectCollisions(vector<Unit*> pUnArr)
{

}
