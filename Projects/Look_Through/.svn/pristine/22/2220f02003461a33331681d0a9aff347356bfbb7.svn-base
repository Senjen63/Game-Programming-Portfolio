#pragma once

#include <allegro5/allegro.h>
#include <allegro5/allegro_font.h>
#include <allegro5/allegro_ttf.h>
#include <allegro5/allegro_audio.h>
#include <allegro5/allegro_acodec.h>
#include <allegro5/allegro_image.h>
#include <allegro5/allegro_primitives.h>

#include <Trackable.h>
#include <Vector2D.h>
#include <EventSystem.h>

#include <iostream>
#include <cassert>
#include <string>
#include <fstream>

#include <PerformanceTracker.h>
#include <Timer.h>
#include <EventSystem.h>

#include "GraphicsSystem.h"
#include "InputSystem.h"
#include "Unit.h"
#include "Animation.h"
#include "InputSystem.h"
#include "UnitManager.h"
#include "GraphicsBufferManager.h"
#include "Snake.h"
#include "Collectible.h"
#include "HudManager.h"

#include "CollideEvent.h"
#include "EventListener.h"
#include "CollideListener.h"

using namespace std;

class CollideListener;

//Initialize variables
const string ASSET_PATH = "..\\assets\\";

const int DISP_WIDTH = 840;
const int DISP_HEIGHT = 600;

const float TIME_PER_FRAME = 0.005;
const int NUM_FRAMES = 12;

class Game : public Trackable
{
public:
	~Game();

	void Init();
	void cleanUp();

	void doLoop();
	void setShouldLoop(bool loop);
	void setShouldStart(bool start);

	void render(double time);
	void inputs(Vector2D pos);
	void update(double dt);

	static Game* getInstance();
	static void createInstance();
	static void destroyInstance();

	void displayStart();
	void endGame();
	void resetGame();

	void readFiles();
	void readLevelData(string fileName);
	void spawnFood();
	int getFoodPoints();
	void addScore(int value);
	void progressLevel();
	void clearLevel();

private:
	Game();

	static Game* mpGameInstance;

	GraphicsBufferManager* mpBufferManager;
	GraphicsSystem* mpDisplay;
	InputSystem mInput;
	UnitManager* mpSnakeUnitManager;
	UnitManager* mpCollectibleUnitManager;
	UnitManager* mpWallManager;
	Snake* mpSnake;
	Collectible* mpCollect;
	HudManager* mpHud;

	Animation* mpBallsAnimation;
	Animation* mpSpeedAnimation;
	Animation* mpSlowAnimation;
	Animation* mpPointsAnimation;
	Animation* mpFoodAnimation;
	Animation* mpWallAnimation;

	bool isInit;
	bool shouldLoop;
	bool shouldStart;
	bool shouldEndGame;
	bool shouldPlayAgain;

	string backgroundFileName;
	string snakeFileName;
	string speedFileName;
	string slowFileName;
	string pointsFileName;
	string foodFileName;
	string wallFileName;

	int mPlayerSpeed;
	int mSpawnRate;
	int mFrameCount;
	int mScore;
	int mBodyMax;
	int mBodyStart;
	int mCurrentLevel;
	int mMaxLevels;
	int mFoodPoints;

	EventSystem* pEventSystem;
	CollideListener* pCollideListener;

	Timer levelTimer;
};