#pragma once
#include <algorithm>
#include <fstream>

#include <Trackable.h>
#include <PerformanceTracker.h>
#include <EventSystem.h>
#include <EventListener.h>

#include "InputSystem.h"
#include "InputTranslator.h"
#include "MessageEvent.h"
#include "SpawnWallEvent.h"
#include "SpawnSpikeEvent.h"
#include "SpawnArrowTrapEvent.h"
#include "SpawnArrowEvent.h"
#include "SpawnCollectibleEvent.h"
#include "TimeEvent.h"
#include "FpsEvent.h"
#include "AddScoreEvent.h"
#include "ScoreEvent.h"
#include "EndLevelEvent.h"
#include "GraphicsSystem.h"
#include "UnitManager.h"
#include "HUD.h"
#include "GraphcisBufferManager.h"
#include "AnimationManager.h"
#include "LevelManager.h"
#include "MenuSystem.h"
#include "LanguageSystem.h"
#include "PlayerUnit.h"
#include "ArrowTrapUnit.h"
#include "SoundManager.h"

const int X_SECTIONS = 4;
const int Y_SECTIONS = 4;

const int FRAME_CHANGE_FACTOR = 40;
const int FRAME_RATE_CAP = 120;
const int FRAME_RATE_MIN = 1;

const int PLAYER_FRAME_RATE = 12;
//const int POWER_UP_FRAME_RATE = 15;
const int COLLECT_FRAME_RATE = 15;

const int DEFAULT_WIDTH = 800;
const int DEFAULT_HEIGHT = 600;

const int FONT_SIZE = 24;

const Vector2D LEFT_DIRECTION = Vector2D(-1, 0);
const Vector2D RIGHT_DIRECTION = Vector2D(1, 0);
const Vector2D UP_DIRECTION = Vector2D(0, -1);
const Vector2D DOWN_DIRECTION = Vector2D(0, 1);
const Vector2D SNAKE_START_DIRECTION = RIGHT_DIRECTION;
const int MIN_SNAKE_SPEED = 1;

const float ARROW_LIFE = 10.0f;
const float ARROW_SPEED = 15.0f * PIXELS_IN_FOOT;

const string LOOP_TRACKER_NAME = "loop";

const string ASSET_PATH = "..\\Assets\\";
const string COMMON_ASSET_PATH = "..\\..\\common\\assets\\";

/*
=======================================================================================================================

Tags are used as keys to access buffers stored by GraphicsBufferManager and AnimationFrames stored by AnimationManager.
These constants should never match and keep the references to resources uniform throughout the project.

=======================================================================================================================
*/
const string PLAYER_TAG = "Player";
const string PLAYER_IDLE_TAG = "PlayerIdle";
const string PLAYER_WALK_TAG = "PlayerWalk";
const string HEAD_TAG = "Head";
const string BODY_TAG = "Body";
const string FOOD_TAG = "Food";
const string BONUS_POINTS_TAG = "BonusPoints";
const string SPEED_UP_TAG = "SpeedUp";
const string SLOW_DOWN_TAG = "SlowDown";
const string WALL_TAG = "Wall";
const string SPIKE_TAG = "Spike";
const string ARROW_TRAP_TAG = "ArrowTrap";
const string ARROWS_TAG = "Arrows";
const string COLLECTIBLE_TAG = "Collectible";
const string COLLECTIBLE_ANIM_TAG = "CollectibleAnim";
const string DOOR_TAG = "Door";
const string BACKGROUND_TAG = "Background";
const string START_TAG = "Start";
const string START_HOVER_TAG = "StartHover";
const string LOAD_TAG = "Load";
const string LOAD_HOVER_TAG = "LoadHover";
const string OPTIONS_TAG = "Options";
const string OPTIONS_HOVER_TAG = "OptionsHover";
const string QUIT_TAG = "Quit";
const string QUIT_HOVER_TAG = "QuitHover";
const string NEXT_TAG = "Next";
const string NEXT_HOVER_TAG = "NextHover";
const string BACK_TAG = "MainMenu";
const string BACK_HOVER_TAG = "BackHover";
const string FIRST_LANG_TAG = "FirstLang";
const string FIRST_LANG_HOVER_TAG = "FirstLangHover";
const string SECOND_LANG_TAG = "SecondLang";
const string SECOND_LANG_HOVER_TAG = "SecondLangHover";
const string THIRD_LANG_TAG = "ThirdLang";
const string THIRD_LANG_HOVER_TAG = "ThirdLangHover";
const string EASY_TAG = "Easy";
const string EASY_HOVER_TAG = "EasyHover";
const string MEDIUM_TAG = "Medium";
const string MEDIUM_HOVER_TAG = "MediumHover";
const string HARD_TAG = "Hard";
const string HARD_HOVER_TAG = "HardHover";
const string SOUND_ON_TAG = "SoundOn";
const string SOUND_ON_HOVER_TAG = "SoundOnHover";
const string SOUND_OFF_TAG = "SoundOff";
const string SOUND_OFF_HOVER_TAG = "SoundOffHover";

const string ARROW_SHOOT_TAG = "ArrowShoot";
const string ARROW_STAB_TAG = "ArrowStab";
const string COLLECTIBLE_GRABBED_TAG = "CollectibleGrabbed";
const string DEATH_TAG = "Death";
const string DOOR_OPEN_TAG = "DoorOpen";
const string DRIP_TAG = "Drip";
const string GAME_WIN_TAG = "GameWin";
const string IDLE_SOUND_TAG = "IdleSound";
const string JUMP_SOUND_TAG = "JumpSound";
const string GAME_LOSE_TAG = "GameLose";
const string SPIKE_STAB_TAG = "SpikeStab";
const string WALK_SOUND_TAG = "WalkSound";

const string FONT_TAG = "Font";

const string LEVEL_ZERO_TAG = "Level0";
const string LEVEL_ONE_TAG = "Level1";
const string LEVEL_TWO_TAG = "Level2";
const string LEVEL_SAVE_TAG = "Save";

const string STRINGS_TAG = "Strings";

const string ASSET_NAMES_FILENAME = "asset_names.txt";

const Color WHITE = Color(255, 255, 255);
const Color LIGHT_GRAY = Color(200, 200, 200);
const Color GRAY = Color(125, 125, 125);
const Color BLACK = Color(0, 0, 0);
const Color COLOR_BUTTON_IDLE = GRAY;
const Color COLOR_BUTTON_HOVER = LIGHT_GRAY;

const Vector2D PLAYER_SECTIONS = Vector2D(1, 1);
const Vector2D PLAYER_IDLE_SECTIONS = Vector2D(3, 2);
const Vector2D PLAYER_WALK_SECTIONS = Vector2D(3, 3);
const Vector2D HEAD_SECTIONS = Vector2D(1, 1);
const Vector2D BODY_SECTIONS = Vector2D(1, 1);
const Vector2D FOOD_SECTIONS = Vector2D(2, 2);
const Vector2D SPEED_SECTIONS = Vector2D(2, 2);
const Vector2D SLOW_SECTIONS = Vector2D(2, 2);
const Vector2D BONUS_SECTIONS = Vector2D(2, 2);
const Vector2D WALL_SECTIONS = Vector2D(1, 1);
const Vector2D SPIKE_SECTIONS = Vector2D(1, 1);
const Vector2D ARROWTRAP_SECTIONS = Vector2D(1, 1);
const Vector2D ARROWS_SECTIONS = Vector2D(1, 1);
const Vector2D COLLECTIBLE_SECTIONS = Vector2D(1, 1);
const Vector2D COLLECTIBLE_ANIM_SECTIONS = Vector2D(3, 3);
const Vector2D DOOR_SECTIONS = Vector2D(1, 1);
const Vector2D BACKGROUND_SECTIONS = Vector2D(1, 1);
const Vector2D START_SECTIONS = Vector2D(1, 1);
const Vector2D LOAD_SECTIONS = Vector2D(1, 1);
const Vector2D OPTIONS_SECTIONS = Vector2D(1, 1);
const Vector2D QUIT_SECTIONS = Vector2D(1, 1);
const Vector2D NEXT_SECTIONS = Vector2D(1, 1);
const Vector2D BACK_SECTIONS = Vector2D(1, 1);

const float ARROW_SHOOT_VOLUME = 50;
const float ARROW_STAB_VOLUME = 100;
const float COLLECTIBLE_GRABBED_VOLUME = 65;
const float DEATH_VOLUME = 100;
const float DOOR_OPEN_VOLUME = 45;
const float DRIP_VOLUME = 15;
const float GAME_WIN_VOLUME = 100;
const float IDLE_SOUND_VOLUME = 45;
const float JUMP_SOUND_VOLUME = 65;
const float LOSE_VOLUME = 100;
const float SPIKE_STAB_VOLUME = 100;
const float WALK_VOLUME = 50;




class Game : public EventListener
{
    private:
        static Game* mspGame;
        
        LanguageSystem* mpLangSystem = nullptr;

        EventSystem* mpEventSystem = nullptr;
        GraphicsSystem* mpGraphics = nullptr;
        UnitManager* mpUnitManager = nullptr;
        GraphicsBufferManager* mpGBManager = nullptr;
        AnimationManager* mpAnimManager = nullptr;
        LevelManager* mpLevelManager = nullptr;
        SoundManager* mpSoundManager = nullptr;

        InputSystem mInput;
        InputTranslator mTranslator;

        MenuSystem* mpMenuSystem = nullptr;

        PlayerUnit* mpPlayer = nullptr;
        Unit* mpDoor = nullptr;

        HUD* mpHud = nullptr;

        string mPlayerFilename = "";
        string mPlayerIdleFilename = "";
        string mPlayerWalkFilename = "";
        string mBodyFilename = "";
        string mHeadFilename = "";
        string mFoodFilename = "";
        string mSpeedUpFilename = "";
        string mSlowDownFilename = "";
        string mBonusPointsFilename = "";
        string mWallFilename = "";
        string mSpikeFilename = "";
        string mArrowTrapFilename = "";
        string mArrowsFilename = "";
        string mCollectibleFilename = "";
        string mCollectibleAnimFilename = "";
        string mDoorFilename = "";
        string mBackgroundFilename = "";
        
        string mArrowShootFilename = "";
        string mArrowStabFilename = "";
        string mCollectibleGrabbedFilename = "";
        string mDeathFilename = "";
        string mDoorOpenFilename = "";
        string mDripFilename = "";
        string mGameWinFilename = "";
        string mIdleSoundFilename = "";
        string mJumpSoundFilename = "";
        string mGameLoseFilename = "";
        string mSpikeStabFilename = "";
        string mWalkSoundFilename = "";

        string mFontFilename = "";

        string mStringsFilename = "";

        string mLevelZeroFilename = "";
        string mLevelOneFilename = "";
        string mLevelTwoFilename = "";
        string mSaveFilename = "";

        Font* mpFont = nullptr;

        float* mTimeScale = new float(1000); //number of milliseconds played every second (typically 1000, idea is that setting it to 0 would pause the game, untested)
        int mFps = 60;
        float mTimePerFrame = *mTimeScale / mFps;
        float mTimeRemainingInLevel = 0; //in seconds
        float mActualFps = 0;

        int mPoints = 0;

        bool mPlayLevel = false;
        bool mNextLevel = false;
        bool mEndGame = false;

        bool mInitialized = false;
        bool mCleaned = false;

        Vector2D mWidthHeight;

        Game();
        Game(Vector2D widthHeight);
        ~Game();
        
    public:
        static void createGame();
        static void createGame(Vector2D widthHeight);
        static void destroyGame();

        static Game* getGame();

        void init();
        void cleanup();

        GraphicsSystem* getGraphicsSystem();
        UnitManager* getUnitManager();
        float* getTimeScale();
        float getTimePerFrame();

        void loadFilenames();

        void generateButtonBuffers();

        virtual void handleEvent(const Event& currentEvent);

        void input();
        void update(float elapsedTime);
        void render();
        void fireHudEvents(float elapsedTime);
        void loadSelectedLevel(unsigned int level, Vector2D wallSections, bool loadingSave);
        void endLevel();
        void gameLoop();

        Vector2D findEmptyPosition(float xDiameter, float yDiameter);
};