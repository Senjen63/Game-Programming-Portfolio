#pragma once

#include <list>
#include "GraphicsSystem.h"
#include "Component.h"
#include "Vector2D.h"
#include "Game.h"
#include "Unit.h"
#include "SnakeBodyComponent.h"
#include "EventListener.h"
#include "Event.h"
#include "KeyPressEvent.h"
#include "GameEvent.h"
#include "ICollisionHandler.h"
#include "SpeedPowerUpComponent.h"
#include "ScoreChangeEvent.h"
#include "FruitCollectedEvent.h"
#include "SnakeDiedEvent.h"

class SnakeBodyComponent;

class SnakeComponent : public Component, public EventListener, public ICollisionHandler
{
	const int MOVE_AMOUNT = 32;

	std::list<SnakeBodyComponent*> mBodyComponents;

	float mTimePassedSinceLastMove = 0.0f;
	float mMoveDelay; // How long between moves in milliseconds

	Vector2D mCurrentDirection;
	Vector2D mPrevDirection = Vector2D(0, 0);
	Vector2D mPrevPosition = Vector2D(0, 0);

	bool mLoaded = true;

	void tryChangeDirection(Keycode pressedKey);
	void moveSnake();

public:
	SnakeComponent(Vector2D startDirection = Vector2D(0, 0), float moveDelay = 160.0f);
	~SnakeComponent() { EventSystem::getInstance()->removeListenerFromAllEvents(this); }

	void init();

	void update(float dt) override;
	void draw(GraphicsSystem* gSys) override;

	void handleEvent(const Event& theEvent) override;

	void spawnNewSegment();

	float getMoveDelay() { return mMoveDelay; }
	void setMoveDelay(float moveDelay) { mMoveDelay = moveDelay; }

	std::string getIdentifier() override;

	void onCollision(Unit* unit, CollisionLayer layer) override;

	void speedPowerUpCollected(Unit* unit);
	void scorePowerUpCollected(Unit* unit);
	void fruitCollected(Unit* unit);
};

